<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login</title>
</head>

<body>
    <section>
        <article>
            <form id="formularioPrueba" action="" method="get">
                <fieldset>
                    <legend>Acceder a la cuenta</legend>
                    <label for="nombre">Nombre:</label>
                    <br>
                    <input type="text" id="nombre" required />
                    <br>
                    <label for="pass">Contraseña:</label>
                    <br>
                    <input type="password" id="pass" required />
                    <br>
                    <label for="email">Correo:</label>
                    <br>
                    <input type="email" id="email" required>
                    <br>
                    <input type="submit" name="enviar" id="enviar" value="Enviar" />
                </fieldset>
            </form>
            <br>
            <div id="confirmacion"></div>
        </article>
    </section>
    <script>
        window.onload = iniciar;
        function iniciar() {
            //Variables globales a la funcion iniciar
            var encontrado = false;
            var nombre = "";
            function compruebaNombre() {
                //Busqueda secuencial del nombre en localStorage
                var i = 0;
                while (i < localStorage.length && this.value != localStorage.key(i)) {
                    i++;
                }
                if (i == localStorage.length) { //si no ha encontrado el nombre
                    document.getElementById("confirmacion").innerHTML = "No se encuentra el usuario.";
                    encontrado = false;
                } else {
                    document.getElementById("confirmacion").innerHTML = "";
                    nombre = localStorage.key(i); //Aqui guardo el nombre, que es la key del localStorage
                    encontrado = true;
                }
            }
            document.getElementById("nombre").addEventListener('blur', compruebaNombre, false);
            function compruebaLogin() {
                event.preventDefault();
                if (encontrado) {
                    objetoNombre = JSON.parse(localStorage.getItem(nombre));
                    if (document.getElementById("pass").value != objetoNombre.pass) {
                        document.getElementById("confirmacion").innerHTML = "La contraseña no es correcta";
                        //alert( objetoNombre.contrasenia);
                    } else {
                        document.getElementById("confirmacion").innerHTML = "";
                        if (objetoNombre.haCompletadoFormulario) {
                            objetoNombre.haEntrado=true;
                            localStorage.setItem(nombre, JSON.stringify(objetoNombre));//sobreescribe el mismo item, cambiando solo el haEncontrado
                            //va a página de calcular cambios
                            //Poner haEntrado a true.((IMPORTANTE))
                            window.open("cambiaRuedas.html", "_self");
                        } else {
                            objetoNombre.haEntrado=true;
                            localStorage.setItem(nombre, JSON.stringify(objetoNombre));
                            //va a página formulario de cómo patina
                            //Poner haEntrado a true.((IMPORTANTE))
                            window.open("formularioPrincipal.html","_self");
                        }
                    }
                }
            }
            document.getElementById("enviar").addEventListener('click', compruebaLogin, false);
        }
    </script>
</body>

</html>